<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore di Password Sicure - Compatto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --bg-light: rgba(255,255,255,0.95);
            --bg-dark: rgba(0,0,0,0.8);
            --text-primary: #1a1a1a;
            --text-secondary: #2c3e50;
            --border: rgba(44,62,80,0.3);
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 50%, #95a5a6 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: var(--bg-light);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 32px;
            width: 90%;
            max-width: 700px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.5px;
        }
        
        .instruction {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .password-display {
            background: var(--bg-dark);
            color: #ffffff;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            font-size: 1.4rem;
            font-weight: 600;
            min-height: 80px;
            word-break: break-all;
            text-align: center;
            border: 3px solid var(--primary);
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: var(--transition);
        }
        
        .password-display.generated {
            animation: flash 0.5s ease;
            border-color: var(--success);
        }
        
        @keyframes flash {
            0%, 100% { background: var(--bg-dark); }
            50% { background: var(--success); }
        }
        
        .entropy-section {
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .entropy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .entropy-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .status-ready { background: var(--success); }
        .status-collecting { 
            background: var(--accent); 
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .entropy-toggle {
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .entropy-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .entropy-info label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .entropy-bar {
            width: 100%;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--primary);
        }
        
        .entropy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--success));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 8px;
        }
        
        .seed-display {
            background: var(--bg-dark);
            color: white;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            max-height: 120px;
            overflow-y: auto;
            border: 2px solid var(--primary);
            margin-top: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .controls {
            margin-bottom: 24px;
        }
        
        .controls label {
            display: block;
            margin-bottom: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        
        input[type="range"] {
            width: 100%;
            height: 16px;
            border-radius: 8px;
            background: var(--bg-dark);
            outline: none;
            -webkit-appearance: none;
            border: 2px solid var(--primary);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 3px solid white;
            transition: var(--transition);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .length-display {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 800;
            margin-top: 12px;
            background: var(--primary);
            color: white;
            padding: 16px;
            border-radius: var(--radius);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            background: var(--bg-light);
            padding: 16px;
            border-radius: var(--radius);
            border: 2px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .checkbox-container:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .checkbox-container input {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--secondary);
        }
        
        .checkbox-container label {
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        button {
            padding: 18px 16px;
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border: 3px solid transparent;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        
        button:active { transform: translateY(-1px); }
        
        #generateBtn {
            background: linear-gradient(135deg, var(--success), #2ecc71);
        }
        
        #generateBtn:hover { border-color: var(--success); }
        
        #copyBtn {
            background: linear-gradient(135deg, var(--warning), #e67e22);
        }
        
        #copyBtn:hover { border-color: var(--warning); }
        
        #saveBtn {
            background: linear-gradient(135deg, var(--accent), #c0392b);
        }
        
        #saveBtn:hover { border-color: var(--accent); }
        
        .instructions {
            margin-top: 24px;
            padding: 24px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            border-left: 6px solid var(--secondary);
        }
        
        .instructions h3 {
            margin-bottom: 16px;
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .instructions ul {
            padding-left: 24px;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .instructions strong {
            color: var(--primary);
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 2rem; }
            .checkboxes { grid-template-columns: 1fr; }
            .buttons { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 Secure Password Generator</h1>
        
        <div class="instruction">
            🖱️ Muovi il mouse o scorri il dito per raccogliere entropia, poi genera la password
        </div>
        
        <div class="password-display" id="passwordDisplay">
            La tua password sicura apparirà qui
        </div>
        
        <div class="entropy-section">
            <div class="entropy-header">
                <h3>
                    🔐 Entropia Raccolta 
                    <span class="status-indicator status-collecting" id="entropyStatus"></span>
                </h3>
                <button class="entropy-toggle" id="toggleEntropy">Mostra Seed</button>
            </div>
            
            <div class="entropy-info">
                <label>Progresso: <span id="entropyCount">0</span>/1000 punti</label>
                <div class="entropy-bar">
                    <div class="entropy-fill" id="entropyFill"></div>
                </div>
            </div>
            
            <div class="seed-display" id="seedDisplay" style="display: none;">
                Seed: Nessun seed generato ancora
            </div>
        </div>
        
        <div class="controls">
            <label>Lunghezza Password: <span id="lengthValue">16</span> caratteri</label>
            <input type="range" id="lengthSlider" min="8" max="128" value="16">
            <div class="length-display" id="lengthDisplay">16 caratteri</div>
        </div>
        
        <div class="checkboxes">
            <div class="checkbox-container">
                <input type="checkbox" id="uppercase" checked>
                <label>Maiuscole (A-Z)</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="lowercase" checked>
                <label>Minuscole (a-z)</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="numbers" checked>
                <label>Numeri (0-9)</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="specialChars" checked>
                <label>Caratteri Speciali (!@#$...)</label>
            </div>
        </div>
        
        <div class="buttons">
            <button id="generateBtn">🎲 Genera Password</button>
            <button id="copyBtn">📋 Copia Password</button>
            <button id="saveBtn">💾 Salva File</button>
        </div>
        
        <div class="instructions">
            <h3>🛡️ Sicurezza Avanzata:</h3>
            <ul>
                <li><strong>Entropia Fisica:</strong> I tuoi movimenti generano casualità crittografica reale</li>
                <li><strong>Multi-Hash SHA-512:</strong> 10.000 iterazioni per massima sicurezza</li>
                <li><strong>Crypto API Browser:</strong> Combinata con entropia fisica e temporale</li>
                <li><strong>Seed Visibile:</strong> Controlla il seed generato dai tuoi movimenti</li>
                <li><strong>Zero Storage:</strong> Nessun dato viene salvato o trasmesso</li>
            </ul>
        </div>
    </div>

    <script>
        // Configurazione compatta
        const CONFIG = {
            MAX_ENTROPY: 1000,
            HASH_ROUNDS: 10000,
            CHARSETS: {
                uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                lowercase: 'abcdefghijklmnopqrstuvwxyz',
                numbers: '0123456789',
                special: '!@#$%^&*()_+-=[]{}|;:,.<>?~`'
            }
        };
        
        // Elementi DOM con destructuring
        const {
            passwordDisplay, lengthSlider, lengthValue, lengthDisplay,
            generateBtn, copyBtn, saveBtn, entropyCount, entropyFill,
            entropyStatus, seedDisplay, toggleEntropy,
            uppercase, lowercase, numbers, specialChars
        } = {
            passwordDisplay: document.getElementById('passwordDisplay'),
            lengthSlider: document.getElementById('lengthSlider'),
            lengthValue: document.getElementById('lengthValue'),
            lengthDisplay: document.getElementById('lengthDisplay'),
            generateBtn: document.getElementById('generateBtn'),
            copyBtn: document.getElementById('copyBtn'),
            saveBtn: document.getElementById('saveBtn'),
            entropyCount: document.getElementById('entropyCount'),
            entropyFill: document.getElementById('entropyFill'),
            entropyStatus: document.getElementById('entropyStatus'),
            seedDisplay: document.getElementById('seedDisplay'),
            toggleEntropy: document.getElementById('toggleEntropy'),
            uppercase: document.getElementById('uppercase'),
            lowercase: document.getElementById('lowercase'),
            numbers: document.getElementById('numbers'),
            specialChars: document.getElementById('specialChars')
        };
        
        // State
        let state = {
            entropyData: [],
            lastEventTime: 0,
            currentSeed: null,
            seedVisible: false,
            pageLoadTime: performance.now()
        };
        
        // Utility functions
        const updateDisplay = (element, value) => element.textContent = value;
        const getTimestamp = () => new Date().toISOString().replace(/[:.]/g, '-');
        
        // Slider handler
        lengthSlider.oninput = () => {
            const value = lengthSlider.value;
            updateDisplay(lengthValue, value);
            updateDisplay(lengthDisplay, `${value} caratteri`);
        };
        
        // Toggle entropy display
        toggleEntropy.onclick = () => {
            state.seedVisible = !state.seedVisible;
            seedDisplay.style.display = state.seedVisible ? 'block' : 'none';
            updateDisplay(toggleEntropy, state.seedVisible ? 'Nascondi Seed' : 'Mostra Seed');
        };
        
        // Entropy collection
        const collectEntropy = (e) => {
            const currentTime = performance.now();
            const timeDelta = currentTime - state.lastEventTime;
            
            if (timeDelta < 10) return; // Rate limiting
            
            const point = e.type.startsWith('touch') 
                ? { x: e.touches[0].clientX, y: e.touches[0].clientY }
                : { x: e.clientX, y: e.clientY };
            
            state.entropyData.push({
                ...point,
                time: currentTime,
                deltaTime: timeDelta,
                type: e.type
            });
            
            state.lastEventTime = currentTime;
            
            // Keep only latest points
            if (state.entropyData.length > CONFIG.MAX_ENTROPY) {
                state.entropyData.shift();
            }
            
            updateEntropyDisplay();
        };
        
        // Update entropy display
        const updateEntropyDisplay = () => {
            const current = state.entropyData.length;
            const percentage = (current / CONFIG.MAX_ENTROPY) * 100;
            
            updateDisplay(entropyCount, current);
            entropyFill.style.width = `${percentage}%`;
            
            entropyStatus.className = `status-indicator ${current >= CONFIG.MAX_ENTROPY ? 'status-ready' : 'status-collecting'}`;
        };
        
        // Generate secure seed
        const generateSeed = () => {
            if (state.entropyData.length < CONFIG.MAX_ENTROPY) return null;
            
            let entropyString = state.entropyData
                .map(p => `${p.x}:${p.y}:${p.time.toFixed(4)}:${p.deltaTime.toFixed(4)}:${p.type}`)
                .join('|');
            
            entropyString += `|${performance.now() - state.pageLoadTime}:${navigator.userAgent.length}`;
            
            // Multi-round hashing
            let hash = entropyString;
            for (let i = 0; i < CONFIG.HASH_ROUNDS; i++) {
                hash = CryptoJS.SHA512(hash + i + state.currentSeed).toString();
            }
            
            return hash;
        };
        
        // Generate password
        const generatePassword = (length, options) => {
            const userSeed = generateSeed();
            if (!userSeed) {
                alert('Raccogli prima 1000/1000 punti di entropia muovendo il mouse!');
                return null;
            }
            
            // Build charset
            let charset = '';
            if (options.uppercase) charset += CONFIG.CHARSETS.uppercase;
            if (options.lowercase) charset += CONFIG.CHARSETS.lowercase;
            if (options.numbers) charset += CONFIG.CHARSETS.numbers;
            if (options.special) charset += CONFIG.CHARSETS.special;
            
            if (!charset) {
                alert('Seleziona almeno un tipo di carattere!');
                return null;
            }
            
            // Generate crypto array
            const cryptoArray = new Uint32Array(length);
            crypto.getRandomValues(cryptoArray);
            
            // Combine seeds
            const combinedSeed = CryptoJS.SHA512(userSeed + cryptoArray.join('')).toString();
            state.currentSeed = combinedSeed;
            
            // Update seed display
            if (state.seedVisible) {
                updateDisplay(seedDisplay, `Seed (${combinedSeed.length} chars): ${combinedSeed}`);
            }
            
            // Generate password
            let password = '';
            for (let i = 0; i < length; i++) {
                const seedHex = combinedSeed.substring((i * 4) % (combinedSeed.length - 4), (i * 4) % (combinedSeed.length - 4) + 4);
                const seedNum = parseInt(seedHex, 16);
                const cryptoNum = cryptoArray[i % cryptoArray.length];
                const combinedIndex = (seedNum + cryptoNum) % charset.length;
                password += charset[combinedIndex];
            }
            
            return password;
        };
        
        // Event listeners
        ['mousemove', 'touchmove', 'touchstart'].forEach(event => 
            document.addEventListener(event, collectEntropy, { passive: true })
        );
        
        // Generate button
        generateBtn.onclick = () => {
            const options = {
                uppercase: uppercase.checked,
                lowercase: lowercase.checked,
                numbers: numbers.checked,
                special: specialChars.checked
            };
            
            const password = generatePassword(parseInt(lengthSlider.value), options);
            if (password) {
                updateDisplay(passwordDisplay, password);
                passwordDisplay.classList.add('generated');
                setTimeout(() => passwordDisplay.classList.remove('generated'), 500);
            }
        };
        
        // Copy button
        copyBtn.onclick = () => {
            if (passwordDisplay.textContent === 'La tua password sicura apparirà qui') {
                alert('Prima genera una password!');
                return;
            }
            
            navigator.clipboard.writeText(passwordDisplay.textContent).then(() => {
                const original = copyBtn.textContent;
                updateDisplay(copyBtn, '✅ Copiata!');
                setTimeout(() => updateDisplay(copyBtn, original), 2000);
            });
        };
        
        // Save button
        saveBtn.onclick = () => {
            if (passwordDisplay.textContent === 'La tua password sicura apparirà qui') {
                alert('Prima genera una password!');
                return;
            }
            
            if (!confirm('ATTENZIONE: Salvare password in file di testo non è sicuro.\nCancella il file dopo aver copiato la password in un gestore sicuro.\n\nContinuare?')) {
                return;
            }
            
            const content = `Password: ${passwordDisplay.textContent}\nData: ${new Date().toLocaleString()}${state.currentSeed && state.seedVisible ? `\n\nSeed:\n${state.currentSeed}` : ''}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `password-sicura-${getTimestamp()}.txt`;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        };
        
        // Initialize
        updateEntropyDisplay();
    </script>
</body>
</html>